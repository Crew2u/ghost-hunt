<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Ghost Detector</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

<script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
<script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

<style>
body { margin:0; overflow:hidden; background:black; font-family:monospace; }

#hud {
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  width:320px;
  padding:16px;
  background:radial-gradient(circle at top, #022, #000);
  border:2px solid #0ff;
  border-radius:16px;
  box-shadow:0 0 30px #0ff;
  color:#0ff;
  z-index:10;
}

#compass {
  width:120px;
  height:120px;
  border:2px solid #0ff;
  border-radius:50%;
  margin:0 auto 12px;
  position:relative;
}

#arrow {
  position:absolute;
  bottom:50%;
  left:50%;
  width:4px;
  height:50px;
  background:#0ff;
  transform-origin:bottom center;
  box-shadow:0 0 10px #0ff;
}

#emf {
  height:14px;
  background:#022;
  margin-top:10px;
}

#emfFill {
  height:100%;
  width:0%;
  background:linear-gradient(90deg,#0ff,#fff);
}

#status {
  text-align:center;
  margin-top:8px;
  font-size:13px;
}
</style>
</head>

<body>

<div id="hud">
  <div id="compass">
    <div id="arrow"></div>
  </div>
  <div>EMF SIGNAL</div>
  <div id="emf"><div id="emfFill"></div></div>
  <div id="status">WAITING FOR GPS‚Ä¶</div>
</div>

<a-scene
  embedded
  renderer="alpha:true"
  vr-mode-ui="enabled:false"
  arjs="sourceType:webcam; gpsMinDistance:1; debugUIEnabled:false;"
>

  <a-assets>
    <video id="ghostVid"
      src="ghost_realistic.webm"
      autoplay loop muted playsinline crossorigin="anonymous">
    </video>
  </a-assets>

  <a-camera gps-camera rotation-reader></a-camera>

  <a-entity id="ghost"
    gps-entity-place="latitude:-26.41003; longitude:152.92618"
    visible="false"
    ghost-ai>
    <a-video
      src="#ghostVid"
      width="3"
      height="4"
      position="0 2 0"
      material="transparent:true; opacity:0">
    </a-video>
  </a-entity>

</a-scene>

<script>
const GHOST_LAT = -26.41003;
const GHOST_LON = 152.92618;
const VISIBILITY_DISTANCE = 30;

let playerLat=null, playerLon=null;
let heading=0, smoothHeading=0;

const arrow=document.getElementById("arrow");
const emfFill=document.getElementById("emfFill");
const status=document.getElementById("status");

/* üß≠ COMPASS */
window.addEventListener("deviceorientation", e=>{
  if(e.alpha!==null){
    heading = 360 - e.alpha;
  }
});

/* üìç GPS ‚Äî FIXED */
navigator.geolocation.watchPosition(
  p=>{
    playerLat=p.coords.latitude;
    playerLon=p.coords.longitude;
    status.innerText="SCANNING‚Ä¶";
  },
  err=>{
    status.innerText="GPS ERROR";
    console.error(err);
  },
  {enableHighAccuracy:true}
);

/* üìê MATH */
function distance(a,b,c,d){
  const R=6371e3;
  const dLat=(c-a)*Math.PI/180;
  const dLon=(d-b)*Math.PI/180;
  return R*2*Math.atan2(Math.sqrt(
    Math.sin(dLat/2)**2+
    Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLon/2)**2
  ),Math.sqrt(1));
}

function bearing(a,b,c,d){
  const y=Math.sin((d-b)*Math.PI/180)*Math.cos(c*Math.PI/180);
  const x=Math.cos(a*Math.PI/180)*Math.sin(c*Math.PI/180)-
          Math.sin(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.cos((d-b)*Math.PI/180);
  return (Math.atan2(y,x)*180/Math.PI+360)%360;
}

/* üëª GHOST */
AFRAME.registerComponent("ghost-ai",{
  init(){
    this.video=this.el.querySelector("a-video");
    this.opacity=0;
    this.t=0;
  },
  tick(time,delta){
    if(!playerLat) return;

    const d=distance(playerLat,playerLon,GHOST_LAT,GHOST_LON);
    const visible=d<VISIBILITY_DISTANCE;

    this.el.setAttribute("visible",visible);

    if(!visible){
      emfFill.style.width="0%";
      status.innerText="NO SIGNAL";
      this.video.setAttribute("material","opacity",0);
      return;
    }

    status.innerText="ENTITY DETECTED ("+Math.round(d)+"m)";
    emfFill.style.width=((1-d/VISIBILITY_DISTANCE)*100)+"%";

    this.opacity=Math.min(this.opacity+0.01,0.9);
    this.t+=delta;

    const y=2+Math.sin(this.t/700)*0.4;
    const z=Math.sin(this.t/1000)*1.0;

    this.video.setAttribute("position",`0 ${y} ${z}`);
    this.video.setAttribute("material","opacity",this.opacity);

    const b=bearing(playerLat,playerLon,GHOST_LAT,GHOST_LON);
    smoothHeading+=(b-smoothHeading)*0.05;
    arrow.style.transform=`translateX(-50%) rotate(${smoothHeading-heading}deg)`;
  }
});
</script>

</body>
</html>
